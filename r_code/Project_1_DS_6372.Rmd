---
title: "Project_1_DS_6372"
author: "Jake"
date: "2023-09-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Load Libraries, warning=FALSE, message=FALSE}
library(caret)
library(corrplot)
library(GGally)
library(tidyverse)
library(car)
library(glmnet)
library(ggthemes)
library(vcd)
library(viridis)
library(rpart)
library(rpart.plot)
```
# MSDS 6372 Project 1

## Goal
We would like to predict medical costs for insurance claims.

## EDA

### Things we need to do
  * Deal with missing data if there is any
  * Clean up variable names
  * change data types
  * split data into train/validation split first (then use training data for objectives)

### EDA needs to include
  * discussion of trends between the response and predictors

## Objective 1

We need to create a interpretable model

  * Build a model with the main goal to identify key relationships that is highly interpret able.
  * Provide interpretation of the regression coefficients
    - Include hypotheses testing
    - Interpretation of regression coefficients
    - Confidence intervals
    - Mention the practical vs statistical significance of the predictors
  * Interpretation of at least a subset of the predictors in your final model
    - Tests on coefficients
    - assumption checking
    interpreting those coefficients
  * Feature selection


## Objective 2

Develop a model that can predict the best and do well on future data

  * Train/validation or CV approach for model comparisons
  * Create a linear regression model WITH complexity (not just include a model with predictors that you've eliminated from objective 1)
  * Run one non-parametric model to compare to your complex model
  * Provide measures of fit for comparisons
    - MSE
    - R squared / Ajusted R squared
    - AIC & BIC
  * Use validation set to show results DO NOT tune model based on validation set
  * Feature selection and CV are a must here

## Loading the data and cleaning up all variables



```{r Load the data and clean up}
# Set the seed for reproducibility
set.seed(123)

# Define a function to determine if a variable is categorical or continuous
is_categorical <- function(column, threshold = 10) {
  length(unique(column)) <= threshold
}


# Load data
insurance_data <- read.csv("../raw_data/insurance.csv")

# Check for missing data
sum(is.na(insurance_data)) # No missing data


# Create BMI categories
insurance_data$bmi_category <- cut(insurance_data$bmi,
                                   breaks = c(-Inf, 18.5, 24.9, 29.9, Inf),
                                   labels = c("Underweight", "Normal weight", "Overweight", "Obesity"))

# Create the 'group' variable
insurance_data$group <- with(insurance_data, ifelse(smoker == "no" & age < 43, "non-smoker & age<43",
                                   ifelse(smoker == "no" & age >= 43, "non-smoker & age>=43",
                                          ifelse(smoker == "yes" & bmi < 30, "smoker & bmi<30", 
                                                 "smoker & bmi>=30"))))


# Convert appropriate columns to factors
for (column_name in names(insurance_data)) {
  
  column_data <- insurance_data[[column_name]]
  
  if (is_categorical(column_data)) {
    insurance_data[[column_name]] <- as.factor(column_data)
  }
}


# Determine the size of the dataset and the training set
n <- nrow(insurance_data)
train_size <- floor(0.7 * n)

# Get random indices for the training set
train_indices <- sample(seq_len(n), size = train_size)

# Split the data into training and test sets
train_data <- insurance_data[train_indices, ]
test_data <- insurance_data[-train_indices, ]
insurance_data <- train_data # renaming as insurance_data to make code easier to understand

head(insurance_data)
str(insurance_data)
summary(insurance_data)


```

## Preform Univariate Analysis

```{r}
# Define Freedman-Diaconis bin width calculation
freedman_diaconis_bin_width <- function(data) {
  iqr_val <- IQR(data, na.rm = TRUE)
  n <- length(data)
  2 * iqr_val / (n^(1/3))
}


# Univariate Analysis
for (column_name in names(insurance_data)) {
  
  column_data <- insurance_data[[column_name]]
  
  if (is.factor(column_data)) {
    # Categorical Variable Analysis using ggplot2
    cat_plot <- ggplot(insurance_data, aes(x=column_data)) +
      geom_bar(aes(fill=column_data), color="black") +
      labs(title=paste("Distribution of", column_name), x=column_name) +
      theme_light() +
      scale_fill_brewer(palette="Set2")
    
    print(cat_plot)
    
  } else {
    
    # Continuous Variable Analysis using ggplot2
    bin_width_fd <- freedman_diaconis_bin_width(column_data)
    
    hist_plot <- ggplot(insurance_data, aes(x=column_data)) +
      geom_histogram(binwidth=bin_width_fd, fill="blue", color="black", alpha=0.7) +
      labs(title=paste("Distribution of", column_name), x=column_name) +
      theme_light()
    
    box_plot <- ggplot(insurance_data, aes(y=column_data)) +
      geom_boxplot(fill="blue", color="black", alpha=0.7) +
      labs(title=paste("Boxplot of", column_name), y=column_name) +
      theme_light()
    
    print(hist_plot)
    print(box_plot)
  }
}


```

## Bivariate Analysis

```{r}

# Identify continuous columns
continuous_columns <- names(insurance_data)[sapply(insurance_data, function(x) !is.factor(x))]

for (col1 in continuous_columns) {
  for (col2 in continuous_columns) {
    if (col1 != col2) {
      
      # Scatter plot with color based on values of col1
      scatter_plot <- ggplot(insurance_data, aes_string(x=col1, y=col2)) +
        geom_point(aes_string(color=col1), alpha=0.5) + 
        labs(title=paste("Scatter plot of", col1, "vs.", col2)) +
        theme_light() +
        scale_color_viridis_c()  # Add a color scale
      
      print(scatter_plot)
      
      # Print correlation
      correlation <- cor(insurance_data[[col1]], insurance_data[[col2]], use="complete.obs")
      cat(paste("Correlation between", col1, "and", col2, "is:", round(correlation, 2)), "\n")
      
    }
  }
}

# Identify categorical columns
categorical_columns <- names(insurance_data)[sapply(insurance_data, is.factor)]

for (col1 in continuous_columns) {
  for (col2 in categorical_columns) {
    
    # Box plot
    box_plot <- ggplot(insurance_data, aes_string(x=col2, y=col1)) +
      geom_boxplot(aes(fill=col2)) +
      labs(title=paste("Boxplot of", col1, "by", col2)) +
      theme_light() +
      scale_fill_viridis(discrete=TRUE)
    
    print(box_plot)
    
  }
}


for (col1 in categorical_columns) {
  for (col2 in categorical_columns) {
    if (col1 != col2) {
      
      # Contingency table
      contingency_table <- table(insurance_data[[col1]], insurance_data[[col2]])
      cat("\nContingency table for", col1, "vs.", col2, ":\n")
      print(contingency_table)
      
    }
  }
}

for (col1 in continuous_columns) {
  for (col2 in continuous_columns) {
    if (col1 != col2) {
      for (cat_col in categorical_columns) {
        
        # Scatter plot with color based on categorical column
        scatter_plot <- ggplot(insurance_data, aes_string(x=col1, y=col2)) +
          geom_point(aes_string(color=cat_col), alpha=0.5) + 
          labs(title=paste("Scatter plot of", col1, "vs.", col2, "colored by", cat_col)) +
          theme_light() +
          scale_color_brewer(palette="Set1")
        
        print(scatter_plot)
      }
    }
  }
}

plot <- ggplot(insurance_data, aes(x=age, y=charges, color=smoker)) +
  geom_point(alpha=0.5) +
  geom_smooth(method="lm", se=FALSE) +  # Linear regression per group
  labs(title="Relationship between Age and Charges by Smoking Status") +
  theme_light() +
  scale_color_manual(values=c("red", "blue"))

print(plot)

categorical_columns <- names(insurance_data)[sapply(insurance_data, is.factor) & names(insurance_data) != "smoker"]

for (cat_col in categorical_columns) {
  plot <- ggplot(insurance_data, aes(x=age, y=charges, color=insurance_data[[cat_col]])) +
    geom_point(alpha=0.5) +
    geom_smooth(method="lm", se=FALSE) +
    labs(title=paste("Relationship between Age and Charges by", cat_col)) +
    theme_light()
  print(plot)
}

```


```{r}
# Let's determine the quantiles of 'charges'
quantiles_charges <- quantile(insurance_data$charges, probs = c(0.33, 0.66))

# Segment the data into three groups
group1 <- insurance_data[insurance_data$charges > quantiles_charges[2], ]
group2 <- insurance_data[insurance_data$charges <= quantiles_charges[2] & insurance_data$charges > quantiles_charges[1], ]
group3 <- insurance_data[insurance_data$charges <= quantiles_charges[1], ]

# Let's analyze the characteristics of each group

# Proportion of smokers in each group
cat("Proportion of smokers in Group 1:", mean(group1$smoker == "yes"), "\n")
cat("Proportion of smokers in Group 2:", mean(group2$smoker == "yes"), "\n")
cat("Proportion of smokers in Group 3:", mean(group3$smoker == "yes"), "\n")

# Average age in each group
cat("Average age in Group 1:", mean(group1$age), "\n")
cat("Average age in Group 2:", mean(group2$age), "\n")
cat("Average age in Group 3:", mean(group3$age), "\n")

# Average BMI in each group
cat("Average BMI in Group 1:", mean(group1$bmi), "\n")
cat("Average BMI in Group 2:", mean(group2$bmi), "\n")
cat("Average BMI in Group 3:", mean(group3$bmi), "\n")

# Frequency distribution of children in each group
cat("Frequency distribution of children in Group 1:\n")
print(table(group1$children))

cat("Frequency distribution of children in Group 2:\n")
print(table(group2$children))

cat("Frequency distribution of children in Group 3:\n")
print(table(group3$children))

# Region distribution in each group
cat("Region distribution in Group 1:\n")
print(table(group1$region))

cat("Region distribution in Group 2:\n")
print(table(group2$region))

cat("Region distribution in Group 3:\n")
print(table(group3$region))



# Identify potential categorical columns for faceting
faceting_columns <- names(insurance_data)[sapply(insurance_data, function(x) is.factor(x))]

for (facet_var in faceting_columns) {
  
  plot <- ggplot(insurance_data, aes(x=age, y=charges, color=smoker)) +
    geom_point(alpha=0.6) +
    facet_wrap(as.formula(paste("~", facet_var))) +
    labs(title=paste("Age vs. Charges by Smoker Status, Faceted by", facet_var)) +
    theme_light()
  
  print(plot)
  
}

# Fit the decision tree model
fit <- rpart(charges ~ ., data=insurance_data, method="anova")

# Plot the decision tree
rpart.plot(fit, yesno=2, type=3, box.palette="RdBu", fallen.leaves=TRUE)


# Visualize using ggplot2
library(ggplot2)

p <- ggplot(insurance_data, aes(x=age, y=charges, color=smoker)) +
  geom_point(alpha=0.6) +
  facet_wrap(~ group, scales="free_y") +  # Facet by the new group
  labs(title="Scatterplot of Age vs. Charges by Groups based on Tree Splits") +
  theme_light()

print(p)


# Fit the decision tree model
fit <- rpart(charges ~ ., data=insurance_data, method="anova", control=rpart.control(cp=0.001, maxdepth=3))

# Plot the decision tree
rpart.plot(fit, yesno=2, type=3, box.palette="RdBu", fallen.leaves=TRUE)

```

## Linear model

```{r}


```



